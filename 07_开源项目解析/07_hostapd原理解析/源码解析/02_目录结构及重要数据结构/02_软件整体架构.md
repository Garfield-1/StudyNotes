# 软件设计架构

> 笔者注：由于简中网络和hostapd官网上的大量资料，均是使用旧版本，这里分析时会结合0.5.10与2.9版本的hostapd共同分析
>
> 参考文档：
>
> [Hostapd 详解 | 老张的blog](https://samuelzq.github.io/2022/04/11/hostapd/)
>
> [hostapd: Developers' documentation for hostapd](https://w1.fi/hostapd/devel/index.html)
>
> [hostapd-devel.pdf](https://hostap.epitest.fi/hostapd/hostapd-devel.pdf)



## 软件架构图

<img src="./img/hostapd_软件架构图.png" alt="hostapd_软件架构图" />d

**概述：**

上图来自`hostapd`官网列出的一份`0.5.X`源码说明文档[hostapd-devel.pdf](https://hostap.epitest.fi/hostapd/hostapd-devel.pdf)，此版本时间约为`2008`年，这里仅作一份参考；

从上图中可以看到，整个`hostapd`的核心在于`event loop`模块，从名字可以看出这是一个循环事件的模块；其中各个协议的具体处理和驱动部分处理，均是模块化的处理在循环中去处理

遗憾的是官方文档并未单独去详细说明每个模块的作用与实现，这里必须结合源代码与三方资料进行分析。这里列出一份表格仅作参考（后续更新完善）

| 模块                | 主要作用                                                     |
| ------------------- | ------------------------------------------------------------ |
| `event loop`        | 核心循环，整个`hostapd`程序是一个大的循环，`event loop`提供了一个事件循环的组件 |
| `l2_packet`         | `l2_packet` 模块 的作用是提供一个抽象层，用于处理链路层（`Layer 2`）的数据包发送和接收。它是`hostapd`和`wpa_supplicant`的关键模块之一，主要用于与无线网络的低层协议交互 |
| `configuration`     | 解析和管理配置文件（如 `hostapd.conf`），并将配置选项加载到程序中，以便控制`hostapd`的行为 |
| `ctrl i/f`          | 控制接口（`ctrl i/f`）为另外的应用程序提供了和hostapd交互的接口。通过该接口，外部程序可以对hostapd进行配置 |
| `driver i/f`        | 驱动部分？                                                   |
| `driver events`     | 已废弃？                                                     |
| `EAP`               | `EAP`模块是实现无线网络认证的核心组件之一。`EAP`是一种灵活的认证框架，支持多种认证方法（如`EAP-TLS`、`EAP-PEAP`、`EAP-TTLS` 等），广泛用于无线网络（如`WPA/WPA2`企业模式）和有线网络（如`IEEE 802.1X`） |
| `EAPOL`             | `EAPOL`状态机，实现`IEEE 802.1X`协议的核心部分。它负责在接入点（`AP`）和客户端（`Supplicant`）之间管理认证过程。`EAPOL`是`IEEE 802.1X`的一个关键组件，用于在局域网（`LAN`）中传输 `EAP`消息 |
| `RADIUS`            | `RADIUS`（`Remote Authentication Dial-In User Service`）模块是用于与外部认证服务器进行通信的关键组件。它实现了`RADIUS`协议，用于处理用户认证、授权和计费（`AAA`）请求。`RADIUS`模块通常用于企业级无线网络（如`WPA/WPA2`企业模式），通过与`RADIUS`服务器（如 `FreeRADIUS`）交互来验证客户端的身份 |
| `RADIUS server`     | `RADIUS Server` 模块 的作用是实现一个内置的 `RADIUS` 服务器，用于处理无线网络中的用户认证请求。它允许 `hostapd`在不依赖外部`RADIUS`服务器（如 `FreeRADIUS`）的情况下，直接在接入点（`AP`）上完成用户认证 |
| `RADIUS client`     | `RADIUS Client` 模块 的作用是实现 `RADIUS` 协议的客户端功能，用于与外部 `RADIUS` 服务器通信。它是`hostapd`实现企业级无线网络认证（如 `WPA/WPA2` 企业模式）的关键组件，通过 `RADIUS` 协议将用户认证请求发送到外部 `RADIUS` 服务器，并处理服务器的响应 |
| `RADIUS accounting` | `RADIUS Accounting` 模块 的作用是记录和管理客户端的会话信息，用于网络访问的计费和统计。它通过与外部 `RADIUS` 服务器交互，发送会话相关的会计信息，如会话开始、结束和流量使用情况 |



## event loop模块

待补充

## ctrl i/f模块

待补充

## driver i/f模块

待补充



## l2_packet模块

1. **`l2_packet` 模块的主要功能**

* 发送和接收链路层数据包：

  - 负责在链路层（如以太网或无线链路）上发送和接收数据包

  - 主要用于处理 `EAPOL` 消息（如 `EAPOL-Start`、`EAPOL-Key` 等）

* 接口抽象：

  - 提供一个统一的接口，屏蔽底层操作系统和驱动的差异

  - 支持多种平台（如 `Linux`、`FreeBSD`、`Windows`）和驱动程序

* 事件通知：
  - 监听链路层事件（如接口状态变化、数据包到达等），并将这些事件通知给上层模块。

* 与认证模块交互：

  - 在 `IEEE 802.1X` 认证过程中，`l2_packet` 模块用于发送和接收认证相关的消息。

  - 例如，在 `EAPOL` 握手中，`l2_packet` 模块负责传输 `EAPOL-Key` 消息。

2. **`l2_packet` 模块的实现**

   `l2_packet` 模块的实现根据操作系统和平台的不同而有所变化。以下是一些关键文件：

   - **`src/l2_packet/l2_packet_linux.c`**：`Linux` 平台的实现，使用 `PF_PACKET` 套接字处理链路层数据包

   - **`src/l2_packet/l2_packet_freebsd.c`**：`FreeBSD` 平台的实现

   - **`src/l2_packet/l2_packet_winpcap.c`**：`Windows` 平台的实现，使用 `WinPcap` 库

   - **`src/l2_packet/l2_packet_none.c`**：一个空实现，用于不需要链路层操作的场景

3. **`l2_packet` 模块的工作流程**

   * 初始化：

     - 调用 `l2_packet_init()` 函数初始化模块，绑定到指定的网络接口

     - 设置接收回调函数，用于处理接收到的数据包

   * 发送数据包：

     - 调用 `l2_packet_send()` 函数发送链路层数据包。

     - 例如，在 `EAPOL` 握手中，发送 `EAPOL-Key` 消息。

   * 接收数据包：
     - 当有数据包到达时，底层实现会触发回调函数，将数据包传递给上层模块处理。

   * 清理资源：
     - 调用 `l2_packet_deinit()` 函数释放资源，关闭套接字或其他底层资源。

4. **`l2_packet` 模块的典型使用场景**

   * `EAPOL` 消息传输：
     - 在 `IEEE 802.1X` 认证过程中，`l2_packet` 模块用于传输 EAPOL 消息（如 `EAPOL-Start`、`EAPOL-Key`）。

   * `RADIUS` 交互：
     - 在某些场景下，`l2_packet` 模块可能用于与 RADIUS 服务器交互的低层数据传输。

   * 链路层事件监视：
     - 监听网络接口的状态变化（如接口断开或连接）。

5. **总结**

   `	hostapd` 中的 `l2_packet` 模块是一个关键的底层组件，负责处理链路层数据包的发送和接收。它为上层模块（如 `IEEE 802.1X` 和 `EAPOL` 状态机）提供了一个统一的接口，屏蔽了操作系统和驱动的差异，从而实现跨平台的兼容性和灵活性



## EAP模块

1. **`EAP` 模块的作用**

   `hostapd`中的`EAP`模块主要负责以下任务：

   * **处理 EAP 消息**：接收和解析来自客户端（`Supplicant`）的 `EAP` 消息，并生成响应
   * **与认证服务器交互**：通过`RADIUS`协议与后端认证服务器（如 FreeRADIUS）通信，转发`EAP`消息并接收认证结果
   * **支持多种 EAP 方法**：实现对多种`EAP`方法的支持，如基于证书的`EAP-TLS`、基于用户名和密码的`EAP-PEAP`等
   * **状态管理**：维护每个客户端的`EAP`会话状态，包括认证的开始、进行中和完成3
   * **密钥生成**：在认证成功后，协助生成会话密钥（如 `PMK`），用于后续的加密通信

2. **EAP 模块的主要组成**

   在`hostapd`的代码中，`EAP`模块的实现主要位于`eap_server`目录下，关键文件包括：

   - **`eap.c`**：`EAP` 框架的核心逻辑，负责消息处理和状态管理

   - **`eap_methods.c`**：注册和管理支持的 `EAP` 方法

   - **`eap_tls.c`**：实现 `EAP-TLS` 方法

   - **`eap_peap.c`**：实现 `EAP-PEAP` 方法

   - **`eap_ttls.c`**：实现 `EAP-TTLS` 方法

   - **`eap_server.c`**：`EAP` 服务器的入口点，处理与客户端的交互

3. **EAP 模块的工作流程**
   * 初始化：当客户端连接到 `AP` 时，`hostapd`初始化 `EAP` 会话
   * `EAPOL` 消息交换
     * 客户端通过 `EAPOL`（`Extensible Authentication Protocol over LAN`）协议发送 `EAP-Start` 消息
     * `AP` 的 `EAP` 模块接收消息并启动认证过程
   * `EAP` 消息处理：
     * `AP` 将 `EAP` 请求消息发送给客户端
     * 客户端响应 `EAP` 消息，`AP` 根据配置选择合适的 `EAP` 方法进行处理
   * 与 `RADIUS` 服务器交互：
     * 如果 `AP` 配置为使用外部认证服务器，`EAP` 模块通过 `RADIUS` 协议转发 `EAP` 消息
     * `RADIUS` 服务器验证客户端身份并返回认证结果
   * 认证完成：
     * 如果认证成功，`EAP` 模块生成会话密钥（`PMK`），并将其传递给无线驱动程序，用于后续的加密通信
     * 如果认证失败，`EAP` 模块通知 `AP` 拒绝客户端接入

4. **配置相关**

   在 `hostapd` 的配置文件（如 `hostapd.conf`）中，可以通过以下选项启用和配置 `EAP` 模块：

   - **`ieee8021x=1`**：启用 `IEEE 802.1X/EAP`
   - **`eap_server=1`**：启用内置 `EAP` 服务器
   - **`eap_user_file=/path/to/eap_user`**：指定 `EAP` 用户配置文件
   - **`radius_server_auth`**：配置外部 `RADIUS` 服务器的地址和端口

5. **总结**

   `hostapd`中的 `EAP` 模块是实现无线网络认证的核心组件，负责处理 `EAP` 消息、与认证服务器交互以及生成会话密钥。它通过灵活的框架支持多种认证方法，为无线网络提供了强大的安全性和可扩展性



## EAPOL模块

1. **`EAPOL`状态机的作用**

   `EAPOL`状态机的主要作用是协调和管理以下任务：

   * **初始化认证过程**：当客户端连接到 `AP` 时，`EAPOL` 状态机会启动认证过程
   * **消息交换**：通过 `EAPOL` 协议在客户端和认证服务器（如 `RADIUS`）之间传递 `EAP` 消息
   * **状态管理**：维护认证过程的状态，包括身份验证的开始、进行中和完成
   * **超时和重试**：处理认证超时和重试逻辑
   * **密钥管理**：在认证完成后，协助生成和分发加密密钥（如 `WPA/WPA2` 中的 `PTK` 和 `GTK`）

2. **`EAPOL`状态机的主要状态**

   `EAPOL` 状态机通常包含以下主要状态：

   * **`INITIALIZE`**：初始化状态机，清除所有状态和计时器
   * **`DISCONNECTED`**：表示客户端未连接或认证失败
   * **`CONNECTING`**：表示正在与客户端进行认证消息的交换
   * **`AUTHENTICATED`**：表示认证成功，客户端被允许访问网络
   * **`ABORTING`**：表示认证过程被中止，例如由于超时或错误

3. **`EAPOL`消息类型**

   `EAPOL` 使用以下几种消息类型来完成认证过程：

   * **`EAPOL-Start`**：客户端发送给`AP`，表示开始认证过程
   * **`EAPOL-Logoff`**：客户端发送给`AP`，表示断开连接
   * **`EAPOL-Key`**：用于密钥交换和管理
   * **`EAPOL-Packet`**：用于传输 `EAP` 消息

4. **在`hostapd`中的实现**

   在 `hostapd`的代码中，`EAPOL`状态机的实现通常位于 `eapol_auth`目录下，主要文件包括：

   - **`eapol_auth_sm.c`**：EAPOL 状态机的核心实现
   - **`eapol_auth.c`**：处理 EAPOL 消息的接收和发送
   - **`eap_common.c`**：EAPOL 协议的通用功能

   这些文件共同实现了`EAPOL`状态机的逻辑，包括状态转换、计时器管理和消息处理

5. **工作流程**
   * 客户端发送 `EAPOL-Start` 消息
   * `AP`的`EAPOL`状态机接收消息并启动认证过程
   * `AP`将`EAP`消息转发给认证服务器（如 `RADIUS`）
   * 认证服务器验证客户端身份并返回结果
   * 如果认证成功，`EAPOL` 状态机进入 `AUTHENTICATED` 状态，并完成密钥交换
   * 如果认证失败，状态机进入 `DISCONNECTED` 状态

6. **总结**

   `EAPOL` 状态机是`hostapd`中实现`IEEE 802.1X`协议的核心组件，负责管理认证过程和密钥交换。它通过状态转换和消息处理，确保客户端能够安全地接入网络



## RADIUS模块

1. **`RADIUS` 模块的作用**
   * **用户认证**：将客户端的认证请求（如用户名和密码、证书等）转发给 `RADIUS` 服务器，并接收认证结果
   * **授权管理**：根据 `RADIUS` 服务器的响应，决定客户端是否可以访问网络
   * **计费支持**：在某些场景下，`RADIUS` 模块还可以处理计费相关的请求
   * **EAP 转发**：在使用 `EAP`（`Extensible Authentication Protocol`）认证时，`RADIUS` 模块负责将 `EAP` 消息封装到 `RADIUS` 协议中进行传输

2. **`RADIUS` 模块的主要组成**

   在`hostapd`的代码中，`RADIUS`模块的实现主要位于`radius`目录下，关键文件包括：

   - **`radius.c`**：`RADIUS`客户端的核心实现，负责构建和解析`RADIUS`消息

   - **`radius_client.c`**：实现与`RADIUS`服务器的通信逻辑，包括发送请求和接收响应

   - **`radius_server.c`**：如果`hostapd`配置为`RADIUS`服务器模式，则该文件实现服务器端逻辑

   - **`radius_common.c`**：`RADIUS`协议的通用功能，如消息编码和解码



### RADIUS Server模块

`RADIUS Server` 模块 的作用是实现一个内置的 `RADIUS` 服务器，用于处理无线网络中的用户认证请求。它允许 `hostapd`在不依赖外部`RADIUS`服务器（如 `FreeRADIUS`）的情况下，直接在接入点（`AP`）上完成用户认证

1. **主要功能**

   * **用户认证**：

     - 验证客户端（`Supplicant`）的身份信息，例如用户名和密码、证书或其他认证凭据

     - 支持多种认证协议，如 `EAP`（`Extensible Authentication Protocol`）

   * **授权管理**：

     - 根据认证结果决定客户端是否可以访问网络

     - 可以根据配置为不同用户分配特定的网络权限（如 `VLAN` 分配）

   * **EAP 支持**：

     - 作为 `EAP` 认证的服务器端，支持多种 EAP 方法（如 `EAP-TLS`、`EAP-PEAP`、`EAP-TTLS`等）

     - 处理 `EAPOL` 消息（`EAP over LAN`），与客户端进行认证消息的交换

   * **密钥管理**：
     - 在认证成功后，生成并分发会话密钥（如 `PMK`），用于后续的加密通信

   * **日志记录**：
     - 记录认证请求、响应和结果，便于管理员监控和调试

2. **`RADIUS Server` 模块的实现**

   在`hostapd`的代码中，`RADIUS Server` 模块的实现主要位于以下文件中：

   - **`src/radius/radius_server.c`**：`RADIUS` 服务器的核心逻辑

   - **`src/radius/radius_server_eap.c`**：处理 `EAP` 认证的逻辑

   - **`src/radius/radius_server_conf.c`**：解析和管理 `RADIUS` 服务器的配置

3. **`RADIUS Server` 的工作流程**

   * **初始化**：

     - `hostapd`启动时，加载 `RADIUS` 服务器的配置（如共享密钥、用户数据库等）

     - 初始化 `RADIUS` 服务器模块，监听指定的端口（默认 1812）

   * **接收认证请求**：

     - 客户端通过 `EAPOL` 协议发送认证请求

     - `RADIUS Server` 模块解析请求并提取认证信息

   * **处理认证**：

     - 根据配置的认证方法（如 `EAP-TLS`、`EAP-PEAP` 等），验证客户端的身份

     - 如果使用用户名和密码认证，则会与用户数据库进行匹配

   * **返回认证结果**：

     - 如果认证成功，返回 `Access-Accept` 消息，并附带会话密钥等信息

     - 如果认证失败，返回 `Access-Reject` 消息

   * **后续操作**：
     - 在认证成功后，`RADIUS Server` 可以触发其他操作，例如分配 `VLAN` 或记录日志

4. **总结**

   `hostapd`中的 `RADIUS Server` 模块提供了一个轻量级的认证解决方案，适用于小型网络或测试场景。它通过支持多种 `EAP` 方法和灵活的配置选项，为无线网络提供了基本的认证和授权功能



### RADIUS client模块

在`hostapd`中，`RADIUS Client`模块 的作用是实现 `RADIUS` 协议的客户端功能，用于与外部 `RADIUS` 服务器通信。它是`hostapd`实现用户认证和会计功能的关键组件，主要负责将认证请求和会计信息发送到 `RADIUS` 服务器，并处理服务器的响应

1. **`RADIUS Client`模块的主要功能**

   * 用户认证：
     - 将客户端的认证信息（如用户名、密码或证书）封装为 `RADIUS` 消息，并发送到外部 `RADIUS` 服务器
     - 接收 `RADIUS` 服务器的响应（如 `Access-Accept` 或 `Access-Reject`），并根据结果决定是否允许客户端接入网络

   * 会计功能：
     - 发送会计消息（如 `Accounting-Start`、`Accounting-Stop` 和 `Accounting-Interim-Update`）到 `RADIUS` 服务器，用于记录客户端的会话信息（如会话时长、流量使用等）

   * `EAP` 消息转发：
     - 在使用 `EAP`（`Extensible Authentication Protocol`）认证时，`RADIUS Client` 模块负责将 `EAP` 消息封装到 `RADIUS` 消息中，并与 `RADIUS` 服务器进行交互

   * 消息构建与解析：

     - 构建符合 `RADIUS` 协议的请求消息（如认证请求、会计请求）

     - 解析 `RADIUS` 服务器的响应消息，提取相关信息（如认证结果、会话密钥等）

   * 安全性：

     - 使用共享密钥对 `RADIUS` 消息进行验证，确保消息的完整性和来源可信

     - 支持 `Message-Authenticator` 属性，用于进一步增强消息的安全性

2. **`RADIUS Client`模块的实现**

   在 `hostapd`的代码中，`RADIUS Client` 模块的实现主要位于以下文件中：

   - **`src/radius/radius_client.c`**：`RADIUS` 客户端的核心逻辑，包括消息的构建、发送和接收

   - **`src/radius/radius.c`**：实现 `RADIUS` 消息的通用功能，如消息编码和解码

   - **`src/radius/radius_common.c`**：定义 `RADIUS` 协议的常量和通用操作

3. **`RADIUS Client`的工作流程**

   * 初始化：

     - 在 `hostapd` 启动时，`RADIUS Client` 模块根据配置文件（如 `hostapd.conf`）初始化

     - 配置包括 `RADIUS` 服务器的地址、端口、共享密钥等

   * 发送认证请求：

     - 当客户端发起认证时，`RADIUS Client` 模块将认证信息（如 `EAP` 消息）封装为 RADIUS `Access-Request` 消息

     - 消息通过 `UDP` 发送到配置的 `RADIUS` 服务器

   * 处理认证响应：

     - 接收 `RADIUS` 服务器的响应消息（如 `Access-Accept` 或 `Access-Reject`）

     - 如果认证成功，提取会话密钥（如 `PMK`）并传递给其他模块；如果认证失败，则拒绝客户端接入

4. **会计功能**

   - 在客户端接入网络后，`RADIUS Client` 模块发送 `Accounting-Start` 消息记录会话开始

   - 在会话进行中，定期发送 `Accounting-Interim-Update` 消息报告会话状态

   - 在会话结束时，发送 `Accounting-Stop` 消息记录会话结束

5. **错误处理**：
   - 如果`RADIUS`服务器不可用或响应超时，RADIUS Client 模块会进行重试或切换到备用服务器

6. **总结**

   `hostapd`中的`RADIUS Client` 模块是实现无线网络认证和会计功能的核心组件。它通过与外部 `RADIUS` 服务器交互，完成用户认证、会话记录和流量统计等任务，为企业和公共网络提供了安全性和可管理性

### RADIUS Accounting模块

`RADIUS Accounting`模块 的作用是记录和管理客户端的会话信息，用于网络访问的计费和统计。它通过与外部 `RADIUS` 服务器交互，发送会话相关的会计信息（`Accounting Information`），如会话开始、结束和流量使用情况

1. **RADIUS Accounting 模块的主要功能**

   * 会话开始记录：
     - 当客户端成功通过认证并连接到网络时，发送 `Accounting-Start` 消息到 **RADIUS** 服务器，记录会话的开始时间和相关信息

   * 会话结束记录：
     - 当客户端断开连接或会话超时时，发送 `Accounting-Stop` 消息到 **RADIUS** 服务器，记录会话的结束时间、使用的流量等信息

   * 中间会计更新：
     - 在会话进行中，定期发送 `Accounting-Interim-Update` 消息，报告会话的当前状态和流量使用情况

   * 流量统计：
     - 收集客户端的流量使用数据（如上传和下载的字节数），并将这些数据发送到 **RADIUS** 服务器

   * 计费支持：
     - 为基于使用量的计费系统提供支持，通过记录客户端的会话时长和流量使用情况，生成计费数据

   * 日志记录：
     - 记录会计相关的操作和事件，便于管理员进行监控和调试

2. **`RADIUS Accounting` 模块的实现**

   在 `hostapd`的代码中，`RADIUS Accounting` 模块的实现主要位于以下文件中：

   - **`src/radius/radius_client.c`**：实现 `RADIUS` 客户端的核心逻辑，包括会计消息的构建和发送

   - **`src/radius/radius.c`**：处理 `RADIUS` 消息的通用功能

   - **`src/ap/accounting.c`**：实现与接入点会计相关的逻辑

3. **`RADIUS Accounting` 的工作流程**

   * 会话开始：

     - 客户端通过认证后，`hostapd`调用会计模块，构建 `Accounting-Start` 消息

     - 消息中包含客户端的 `MAC` 地址、`IP` 地址、会话 `ID` 等信息。

     - 消息通过 `UDP` 发送到配置的 `RADIUS` 服务器

   * 中间更新：

     - 在会话进行中，`hostapd`定期发送 `Accounting-Interim-Update` 消息
     - 消息中包含当前会话的状态和流量统计数据

   * 会话结束：

     - 当客户端断开连接或会话超时时，`hostapd`构建 `Accounting-Stop` 消息

     - 消息中包含会话的结束时间、总流量使用情况等信息

   - 服务器响应：
     - `RADIUS` 服务器接收会计消息后，返回响应消息，确认接收到会计数据

4. **总结**

   `hostapd`中的 `RADIUS Accounting` 模块通过与 `RADIUS` 服务器交互，记录客户端的会话信息和流量使用情况，为网络计费和统计提供支持。它是企业网络和公共 `Wi-Fi` 环境中实现用户管理和计费的重要组件
